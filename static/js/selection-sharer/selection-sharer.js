/*
 * share-selection: Medium like popover menu to share on Twitter or by email any text selected on the page 
 * version: 0.0.14
 * -- Requires jQuery --
 * -- AMD compatible  --
 *
 * Author: Xavier Damman (@xdamman)
 * GIT: https://github.com/xdamman/share-selection
 * MIT License
 */

(function(e){var t=function(t){var n=this;t=t||{};if(typeof t=="string")t={elements:t};this.sel=null;this.textSelection="";this.htmlSelection="";this.getSelectionText=function(e){var t="",r="";var e=e||window.getSelection();if(e.rangeCount){var i=document.createElement("div");for(var s=0,o=e.rangeCount;s<o;++s){i.appendChild(e.getRangeAt(s).cloneContents())}r=i.textContent;t=i.innerHTML}n.textSelection=r;n.htmlSelection=t||r;return r};this.selectionDirection=function(e){var t=e||window.getSelection();var n=document.createRange();if(!t.anchorNode)return 0;n.setStart(t.anchorNode,t.anchorOffset);n.setEnd(t.focusNode,t.focusOffset);var r=n.collapsed?"backward":"forward";n.detach();return r};this.showPopunder=function(){n.popunder=n.popunder||document.getElementById("selectionSharerPopunder");var e=window.getSelection();var t=n.getSelectionText(e);if(e.isCollapsed||t.length<10||!t.match(/ /))return n.hidePopunder();if(n.popunder.classList.contains("fixed"))return n.popunder.style.bottom=0;var r=e.getRangeAt(0);var i=r.endContainer.parentNode;if(n.popunder.classList.contains("show")){if(Math.ceil(n.popunder.getBoundingClientRect().top)==Math.ceil(i.getBoundingClientRect().bottom))return;return n.hidePopunder(n.showPopunder)}if(i.nextElementSibling){n.pushSiblings(i)}else{if(!n.placeholder){n.placeholder=document.createElement("div");n.placeholder.className="selectionSharerPlaceholder"}var s=window.getComputedStyle(i).marginBottom;n.placeholder.style.height=s;n.placeholder.style.marginBottom=-2*parseInt(s,10)+"px";i.parentNode.insertBefore(n.placeholder)}var o=window.pageYOffset+i.getBoundingClientRect().bottom;n.popunder.style.top=Math.ceil(o)+"px";setTimeout(function(){if(n.placeholder)n.placeholder.classList.add("show");n.popunder.classList.add("show")},0)};this.pushSiblings=function(e){while(e=e.nextElementSibling){e.classList.add("selectionSharer");e.classList.add("moveDown")}};this.hidePopunder=function(e){e=e||function(){};if(n.popunder=="fixed"){n.popunder.style.bottom="-50px";return e()}n.popunder.classList.remove("show");if(n.placeholder)n.placeholder.classList.remove("show");var t=document.getElementsByClassName("moveDown");while(el=t[0]){el.classList.remove("moveDown")}setTimeout(function(){if(n.placeholder)document.body.insertBefore(n.placeholder);e()},600)};this.show=function(e){setTimeout(function(){var t=window.getSelection();var r=n.getSelectionText(t);if(!t.isCollapsed&&r&&r.length>10&&r.match(/ /)){var i=t.getRangeAt(0);var s=i.getBoundingClientRect().top-5;var o=s+window.scrollY-n.$popover.height();var u=0;if(e){u=e.pageX}else{var a=t.anchorNode.parentNode;u+=a.offsetWidth/2;do{u+=a.offsetLeft}while(a=a.offsetParent)}switch(n.selectionDirection(t)){case"forward":u-=n.$popover.width();break;case"backward":u+=n.$popover.width();break;default:return}n.$popover.removeClass("anim").css("top",o+10).css("left",u).show();setTimeout(function(){n.$popover.addClass("anim").css("top",o)},0)}},10)};this.hide=function(e){n.$popover.hide()};this.smart_truncate=function(e,t){if(!e||!e.length)return e;var n=e.length>t,r=n?e.substr(0,t-1):e;r=n?r.substr(0,r.lastIndexOf(" ")):r;return n?r+"...":r};this.getRelatedTwitterAccounts=function(){var t=[];var n=e('meta[name="twitter:creator"]').attr("content")||e('meta[name="twitter:creator"]').attr("value");if(n)t.push(n);var r=document.getElementsByTagName("a");for(var i=0,s=r.length;i<s;i++){if(r[i].attributes.href&&typeof r[i].attributes.href.value=="string"){var o=r[i].attributes.href.value.match(/^https?:\/\/twitter\.com\/([a-z0-9_]{1,20})/i);if(o&&o.length>1&&["widgets","intent"].indexOf(o[1])==-1)t.push(o[1])}}if(t.length>0)return t.join(",");else return""};this.shareTwitter=function(t){t.preventDefault();if(!n.viaTwitterAccount){n.viaTwitterAccount=e('meta[name="twitter:site"]').attr("content")||e('meta[name="twitter:site"]').attr("value")||"";n.viaTwitterAccount=n.viaTwitterAccount.replace(/@/,"")}if(!n.relatedTwitterAccounts){n.relatedTwitterAccounts=n.getRelatedTwitterAccounts()}var r="“"+n.smart_truncate(n.textSelection.trim(),114)+"”";var i="http://twitter.com/intent/tweet?text="+encodeURIComponent(r)+"&related="+n.relatedTwitterAccounts+"&url="+encodeURIComponent(window.location.href);if(n.viaTwitterAccount&&r.length<120-6-n.viaTwitterAccount.length)i+="&via="+n.viaTwitterAccount;var s=640,o=440;var u=screen.width/2-s/2;var a=screen.height/2-o/2-100;window.open(i,"share_twitter","toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width="+s+", height="+o+",       top="+a+", left="+u);n.hide();return false};this.shareEmail=function(t){var r=n.htmlSelection.replace(/<p[^>]*>/ig,"\n").replace(/<\/p>|  /ig,"").trim();var i={};i.subject=encodeURIComponent("Quote from "+document.title);i.body=encodeURIComponent("“"+r+"”")+"%0D%0A%0D%0AFrom: "+document.title+"%0D%0A"+window.location.href;e(this).attr("href","mailto:?subject="+i.subject+"&body="+i.body);n.hide();return true};this.render=function(){var t='<div class="selectionSharer" id="selectionSharerPopover" style="position:absolute;">'+'  <div id="selectionSharerPopover-inner">'+"    <ul>"+'      <li><a class="action tweet" href="" title="Share this selection on Twitter" target="_blank">Tweet</a></li>'+'      <li><a class="action email" href="" title="Share this selection by email" target="_blank"><svg width="20" height="20"><path stroke="#FFF" stroke-width="6" d="m16,25h82v60H16zl37,37q4,3 8,0l37-37M16,85l30-30m22,0 30,30"/></svg></a></li>'+"    </ul>"+"  </div>"+'  <div class="selectionSharerPopover-clip"><span class="selectionSharerPopover-arrow"></span></div>'+"</div>";var r='<div id="selectionSharerPopunder" class="selectionSharer">'+'  <div id="selectionSharerPopunder-inner">'+"    <label>Share this selection</label>"+"    <ul>"+'      <li><a class="action tweet" href="" title="Share this selection on Twitter" target="_blank">Tweet</a></li>'+'      <li><a class="action email" href="" title="Share this selection by email" target="_blank"><svg width="20" height="20"><path stroke="#FFF" stroke-width="6" d="m16,25h82v60H16zl37,37q4,3 8,0l37-37M16,85l30-30m22,0 30,30"/></svg></a></li>'+"    </ul>"+"  </div>"+"</div>";n.$popover=e(t);n.$popover.find("a.tweet").click(n.shareTwitter);n.$popover.find("a.email").click(n.shareEmail);e("body").append(n.$popover);n.$popunder=e(r);n.$popunder.find("a.tweet").click(n.shareTwitter);n.$popunder.find("a.email").click(n.shareEmail);e("body").append(n.$popunder)};this.setElements=function(t){if(typeof t=="string")t=e(t);n.$elements=t instanceof e?t:e(t);n.$elements.mouseup(n.show).mousedown(n.hide).addClass("selectionShareable");n.$elements.bind("touchstart",function(e){n.isMobile=true});document.onselectionchange=n.selectionChanged};this.selectionChanged=function(e){if(!n.isMobile)return;if(n.lastSelectionChanged){clearTimeout(n.lastSelectionChanged)}n.lastSelectionChanged=setTimeout(function(){n.showPopunder(e)},300)};this.render();if(t.elements){this.setElements(t.elements)}};e.fn.selectionSharer=function(){var e=new t;e.setElements(this);return this};if(typeof define=="function"){define(function(){t.load=function(e,n,r,i){var s=new t;s.setElements("p");r()};return t})}else{window.SelectionSharer=t}})(jQuery)
 
